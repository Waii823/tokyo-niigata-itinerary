<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤§é˜ª Ã— äº¬éƒ½ Ã— ç¥æˆ¶ï½œ8å¤©è¡Œç¨‹ï¼ˆå¯åŒæ­¥ï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f1730;
      --muted:#a7b1c2;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.10);
      --accent:#7aa6ff;
      --accent2:#74f0c5;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --ok:#74f0c5;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(122,166,255,.25), transparent 60%),
                  radial-gradient(1000px 500px at 80% 0%, rgba(116,240,197,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .page{
      max-width: 1160px;
      margin: 0 auto;
      padding: 20px 16px 36px;
    }
    header{
      padding: 18px 14px 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .title-block h1{
      margin: 0 0 6px;
      font-size: 22px;
      letter-spacing: .3px;
    }
    .subtitle{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1.3fr .9fr;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .panel-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 700;
      font-size: 14px;
    }
    .panel-title-dot{
      width:10px;height:10px;border-radius:99px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 3px rgba(122,166,255,.15);
      flex:0 0 auto;
    }
    .panel-subtitle{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
      max-width: 720px;
    }
    .toolbar{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 12px;
      transition: .15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.08);}
    button:active{transform: translateY(0px);}
    .btn-primary{
      border-color: rgba(122,166,255,.35);
      background: rgba(122,166,255,.14);
    }
    .btn-danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.10);
      color: #ffdede;
    }
    .btn-ok{
      border-color: rgba(116,240,197,.35);
      background: rgba(116,240,197,.10);
    }

    .itinerary-list{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .day-card{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(17,26,46,.68);
      overflow:hidden;
    }
    .day-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .day-left{
      min-width: 0;
    }
    .day-title{
      font-weight: 800;
      font-size: 14px;
      margin:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      font-size: 11px;
      padding: 3px 8px;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      color: var(--muted);
      background: rgba(255,255,255,.04);
    }
    .drag-hint{
      color: var(--muted);
      font-size: 11px;
      margin-top:6px;
    }
    .day-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .icon{
      width:14px;height:14px;display:inline-block;
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.35));
      -webkit-mask: var(--mask) no-repeat center / contain;
              mask: var(--mask) no-repeat center / contain;
      opacity:.9;
    }
    .i-edit{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm2.92 2.83H5v-.92l9.06-9.06.92.92L5.92 20.08ZM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/></svg>');}
    .i-trash{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12ZM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4Z"/></svg>');}
    .i-plus{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2Z"/></svg>');}
    .i-reset{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5H5c0 3.87 3.13 7 7 7s7-3.13 7-7-3.13-7-7-7Z"/></svg>');}
    .i-save{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4Zm0 2.5L19.5 8H17V5.5ZM12 19a3 3 0 1 1 0-6 3 3 0 0 1 0 6ZM6 5h9v4H6V5Z"/></svg>');}

    .day-body{
      padding: 10px 12px 12px;
    }

    .items{
      margin: 0;
      padding-left: 18px;
      color: rgba(234,240,255,.95);
      line-height: 1.6;
      font-size: 13px;
    }
    .items li{
      margin: 4px 0;
    }
    .star{
      color: var(--warn);
      font-weight: 800;
    }

    .cost-row{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
    }
    .cost-val{
      color: var(--text);
      font-weight: 800;
      letter-spacing:.2px;
    }

    /* Edit mode */
    .edit-area{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
    }
    input[type="text"], textarea, select{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 10px;
      font-size: 13px;
      outline:none;
    }
    textarea{min-height: 110px; resize: vertical;}

    .right-wrap{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(17,26,46,.68);
      padding: 12px;
    }
    .card h3{
      margin:0 0 8px;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .small{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }
    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
    }
    .table th, .table td{
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 8px 8px;
      font-size: 12px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color: var(--muted); font-weight:700;}
    .table tr:last-child td{border-bottom:none;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row input[type="text"]{flex:1 1 140px;}
    .row select{flex:0 0 120px;}
    .row button{flex:0 0 auto;}

    .sync-ind{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .dot.ok{background: rgba(116,240,197,.9); box-shadow: 0 0 0 3px rgba(116,240,197,.18);}
    .dot.err{background: rgba(255,107,107,.95); box-shadow: 0 0 0 3px rgba(255,107,107,.18);}
    .dot.busy{background: rgba(255,209,102,.95); box-shadow: 0 0 0 3px rgba(255,209,102,.18);}
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="title-block">
        <h1>å¤§é˜ª Ã— äº¬éƒ½ Ã— ç¥æˆ¶ï½œ8å¤©å†¬å­£èˆ‡é™¸å°‘XDåŒè¡Œè¡Œç¨‹</h1>
        <div class="subtitle">
          2026/1/24 13:00 æŠµé”é—œè¥¿åœ‹éš›æ©Ÿå ´ Â· 2026/1/31 20:15 è‡ªé—œè¥¿è¿”ç¨‹<br />
          å¸‚å€ Ã— éƒŠå€ï¼šå¤§é˜ªï¼ˆUSJ/æº«æ³‰/è³¼ç‰©ï¼‰ï¼‹ äº¬éƒ½ï¼ˆåµå±±/æ¸…æ°´å¯ºï¼‰ï¼‹ ç¥æˆ¶ï¼ˆæ¸¯ç£å¤œæ™¯ï¼‰
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- å·¦å´ï¼šè¡Œç¨‹ -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <span class="panel-title-dot"></span> äº’å‹•è¡Œç¨‹è¡¨ï¼ˆå¯æ‹–æ‹½æ’åº / å¯ç·¨è¼¯æ–‡å­—ï¼‰
            </div>
            <div class="panel-subtitle">
              æ‹–æ›³æ¯ä¸€å¤©å¯ä»¥é‡æ–°æ’ç¨‹ï¼›æŒ‰ã€Œä¿®æ”¹è¡Œç¨‹ã€é€²å…¥ç·¨è¼¯æ¨¡å¼ï¼Œæ‰èƒ½ä¿®æ”¹æ¨™é¡Œ / å…§å®¹ / è¡Œç¨‹é …ç›®ã€‚
            </div>
          </div>
          <div class="toolbar">
            <button id="resetOrderBtn">
              <span class="icon i-reset"></span> å›åˆ°å»ºè­°æ’åºï¼ˆæœƒæ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼‰
            </button>
            <button id="editModeBtn" class="btn-primary">
              <span class="icon i-edit"></span> ä¿®æ”¹è¡Œç¨‹
            </button>
          </div>
        </div>
        <div id="itineraryList" class="itinerary-list"></div>
      </section>

      <!-- å³å´ï¼šæ˜ç´°è¨˜è³¬ -->
      <aside class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <span class="panel-title-dot"></span> æ˜ç´°è¨˜è³¬ï¼ˆè‡ªå‹•åŠ ç¸½åˆ°æ¯æ—¥ã€Œå¯¦éš›èŠ±è²»ã€ï¼‰
            </div>
            <div class="panel-subtitle">
              ä»»ä½•äººæ–°å¢/ä¿®æ”¹æ˜ç´°å¾Œï¼Œæœƒå³æ™‚åŒæ­¥çµ¦æ‰€æœ‰äººï¼›æ¯æ—¥ã€Œå¯¦éš›èŠ±è²»ã€ä¸å¯æ‰‹å‹•æ”¹ï¼Œåªç”±æ˜ç´°ç¸½æ•¸è¨ˆç®—ã€‚
            </div>
          </div>
          <div class="toolbar">
            <div class="sync-ind" title="Firestore å³æ™‚åŒæ­¥ç‹€æ…‹">
              <span id="syncDot" class="dot"></span>
              <span id="syncText">æœªé€£ç·š</span>
            </div>
          </div>
        </div>

        <div class="right-wrap">
          <div class="card">
            <h3>å¿«é€Ÿæ–°å¢ä¸€ç­†</h3>
            <div class="row">
              <select id="expDaySelect"></select>
              <select id="expPayerSelect">
                <option value="Lok">Lok</option>
                <option value="Wai">Wai</option>
              </select>
            </div>
            <div class="row">
              <input id="expTitle" type="text" placeholder="é …ç›®ï¼ˆä¾‹ï¼šæ™šé¤ã€äº¤é€šã€é–€ç¥¨â€¦ï¼‰" />
              <input id="expAmount" type="text" placeholder="é‡‘é¡ï¼ˆJPYï¼‰" inputmode="numeric" />
            </div>
            <div class="row">
              <button id="addExpenseBtn" class="btn-ok">
                <span class="icon i-plus"></span> æ–°å¢æ˜ç´°
              </button>
            </div>
            <div class="small">æç¤ºï¼šé‡‘é¡åªæ¥å—æ•¸å­—ï¼›æœƒè‡ªå‹•åŠ ç¸½åˆ°å°æ‡‰æ—¥æœŸã€‚</div>
          </div>

          <div class="card">
            <h3>æ˜ç´°åˆ—è¡¨</h3>
            <table class="table" id="expenseTable">
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>ä»˜æ¬¾äºº</th>
                  <th>é …ç›®</th>
                  <th>é‡‘é¡ (JPY)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="expenseTbody"></tbody>
            </table>
          </div>

          <div class="card">
            <h3>å°æç¤º</h3>
            <div class="small">
              <div class="pill">å¤šäººåŒæ­¥ï¼šåŒä¸€ä»½æ–‡ä»¶</div>
              <div class="pill">æ—…é€”ä¸­ç¶²è·¯ä¸ç©©ï¼šç¨å¾Œæœƒè‡ªå‹•é‡è©¦</div>
              <div class="pill">è¡Œç¨‹æ‹–æ‹½ï¼šå¯è‡ªè¨‚é †åº</div>
            </div>
          </div>
        </div>
      
        <hr style="margin:12px 0;border:0;border-top:1px solid #e5e7eb;" />
        <div class="resv-block">
          <div class="panel-title"><span class="panel-title-dot"></span> è¨‚ä½æ¸…å–® Check-list</div>
          <div class="panel-subtitle">æŠŠã€Œå¿…è¨‚ä½ï¼å»ºè­°è¨‚ä½ã€çš„é¤å»³å…ˆåˆ—å‡ºä¾†ï¼Œå‡ºç™¼å‰é€ä¸€å®Œæˆã€‚</div>
          <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
            <label style="display:flex; gap:8px; align-items:flex-start;"><input type="checkbox" /> Day1ï½œä¸‡ä¸¡ æ—¥æœ¬æ©‹åº—ï¼ˆç‡’è‚‰ï½œå¿…è¨‚ä½ï¼‰â€” <a href="https://maps.google.com/?q=%E4%B8%87%E4%B8%A1%20%E6%97%A5%E6%9C%AC%E6%A9%8B%E5%BA%97" target="_blank" rel="noopener noreferrer">Google Maps</a></label>
            <label style="display:flex; gap:8px; align-items:flex-start;"><input type="checkbox" /> Day4ï½œé®¨ ã‚ˆã—ç”°ï¼ˆåˆå¸‚é™å®šï½œå¿…è¨‚ä½ï¼‰â€” <a href="https://maps.google.com/?q=%E9%AE%A8%20%E3%82%88%E3%81%97%E7%94%B0%20%E4%BA%AC%E9%83%BD" target="_blank" rel="noopener noreferrer">Google Maps</a></label>
            <label style="display:flex; gap:8px; align-items:flex-start;"><input type="checkbox" /> Day4ï½œã¯ã‚Šé‡ é“é “å €æœ¬åº—ï¼ˆå£½å–œç‡’ï½œå¿…è¨‚ä½ï¼‰â€” <a href="https://maps.google.com/?q=%E3%81%AF%E3%82%8A%E9%87%8D%20%E9%81%93%E9%A0%93%E5%A0%80%E6%9C%AC%E5%BA%97" target="_blank" rel="noopener noreferrer">Google Maps</a></label>
            <label style="display:flex; gap:8px; align-items:flex-start;"><input type="checkbox" /> Day6ï½œç¥æˆ¸ç‰›ã‚¹ãƒ†ãƒ¼ã‚­ Ishida. æœ¬åº—ï¼ˆéµæ¿ç‡’ï½œå¿…è¨‚ä½ï¼‰â€” <a href="https://maps.google.com/?q=%E7%A5%9E%E6%88%B8%E7%89%9B%E3%82%B9%E3%83%86%E3%83%BC%E3%82%AD%20Ishida.%20%E6%9C%AC%E5%BA%97" target="_blank" rel="noopener noreferrer">Google Maps</a></label>
            <label style="display:flex; gap:8px; align-items:flex-start;"><input type="checkbox" /> Day7ï½œå¯¿å¸èµ¤é…¢ éŠ ãƒãƒ«ãƒã‚«03ï¼ˆå£½å¸ï½œå»ºè­°è¨‚ä½ï¼‰â€” <a href="https://maps.google.com/?q=%E5%AF%BF%E5%8F%B8%E8%B5%A4%E9%85%A2%20%E9%81%8A%20%E3%83%90%E3%83%AB%E3%83%81%E3%82%AB03" target="_blank" rel="noopener noreferrer">Google Maps</a></label>
          </div>
        </div>
</aside>
    </div>
  </div>

  <!-- Firebase (Firestore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    /***********************
     * 1) Firebase è¨­å®š
     ***********************/
    // âš ï¸ è«‹ä¿æŒèˆ‡ä½ åŸæœ¬å°ˆæ¡ˆä¸€è‡´ï¼ˆä½ ç¾æœ‰ HTML å…§çš„ configï¼‰
    // å¦‚æœä½ ä¹‹å‰å·²ç¶“èƒ½åŒæ­¥æˆåŠŸï¼Œé€™è£¡é€šå¸¸ä¸ç”¨æ”¹ã€‚
   const firebaseConfig = {
      apiKey: "AIzaSyA56n9PCvDn2izWf3cxm8BVWcMK-bPD6OQ",
      authDomain: "tokyo-trip-2026-5edba.firebaseapp.com",
      projectId: "tokyo-trip-2026-5edba",
      storageBucket: "tokyo-trip-2026-5edba.firebasestorage.app",
      messagingSenderId: "565813798352",
      appId: "1:565813798352:web:50bfe09838fa0f6553c5d5",
      measurementId: "G-0XL0C88XX6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ä½ å€‘å…±ç”¨çš„å”¯ä¸€æ–‡ä»¶ï¼ˆé…åˆ Firestore rulesï¼‰
    const tripDocRef = doc(db, "trips", "tokyo-trip-2026");

    /***********************
     * 2) åˆå§‹è¡Œç¨‹ï¼ˆå¤§é˜ª 8 å¤©ï¼‰
     ***********************/
    const initialItinerary = [
      {
        dayKey: "day1",
        dateLabel: "Day 1ï½œ1/24ï¼ˆå…­ï¼‰",
        title: "æŠµé”å¤§é˜ªãƒ»å¸‚å€æš–èº«",
        items: [
          "13:00 æŠµé”é—œè¥¿åœ‹éš›æ©Ÿå ´",
          "13:00â€“14:30 å…¥å¢ƒã€é ˜è¡Œæ",
          "14:45â€“15:30 å—æµ·é›»éµ â†’ é›£æ³¢",
          "15:45â€“16:15 é£¯åº—å¯„æ”¾è¡Œæï¼Check-in",
          "16:30â€“18:00 å¿ƒé½‹æ©‹ç­‹å•†åº—è¡—ï¼ˆæ…¢é€›ã€ä¸è²·é‡ç‰©ï¼‰",
          "16:45â€“17:15 ğŸ± é»å¿ƒï¼š[æœ¬å®¶ å¤§ãŸã“ é“é “å €åº—](https://maps.google.com/?q=%E6%9C%AC%E5%AE%B6%20%E5%A4%A7%E3%81%9F%E3%81%93%20%E9%81%93%E9%A0%93%E5%A0%80%E5%BA%97)ï¼ˆç« é­šç‡’ï½œå¯ç¾å ´ï¼‰",
          "18:30â€“20:00 ğŸ½ æ™šé¤ï¼š[ä¸‡ä¸¡ æ—¥æœ¬æ©‹åº—](https://maps.google.com/?q=%E4%B8%87%E4%B8%A1%20%E6%97%A5%E6%9C%AC%E6%A9%8B%E5%BA%97)ï¼ˆç‡’è‚‰ï½œå¿…è¨‚ä½ï¼‰",
          "20:00â€“ é“é “å €å¤œæ™¯æ•£æ­¥ â†’ å›é£¯åº—ä¼‘æ¯"
        ]
      },
      {
        dayKey: "day2",
        dateLabel: "Day 2ï½œ1/25ï¼ˆæ—¥ï¼‰",
        title: "å¤§é˜ªå¸‚å€ï½œå¸‚å ´ï¼‹å¤œæ™¯",
        items: [
          "09:00 å‡ºé–€",
          "09:30â€“11:00 é»‘é–€å¸‚å ´ï¼ˆæ—©é¤ï¼‹åˆé¤ä¸€èµ·åƒï¼‰",
          "10:00â€“11:00 ğŸ± åˆé¤ï¼š[é»’é–€ä¸‰å¹³](https://maps.google.com/?q=%E9%BB%92%E9%96%80%E4%B8%89%E5%B9%B3)ï¼ˆæµ·é®®ä¸¼ï½œå¯ç¾å ´ï½œåˆå¸‚ï¼‰",
          "11:30â€“13:00 ä¸­å´ç”ºå’–å•¡ï¼å°åº—",
          "13:30â€“15:30 â˜… å›é£¯åº—ä¼‘æ¯æˆ–æ¢…ç”°ç™¾è²¨",
          "16:00â€“17:00 æ¢…ç”°ç©ºä¸­åº­åœ’",
          "17:30â€“18:00 HEP FIVE æ‘©å¤©è¼ª",
          "18:30â€“20:00 ğŸ½ æ™šé¤ï¼š[ãŠå¥½ã¿ç„¼ ãã˜ æœ¬åº—](https://maps.google.com/?q=%E3%81%8A%E5%A5%BD%E3%81%BF%E7%84%BC%20%E3%81%8D%E3%81%98%20%E6%9C%AC%E5%BA%97)ï¼ˆå¤§é˜ªç‡’ï½œå¯ç¾å ´ï¼Œæ’éšŠï¼‰",
          "20:30â€“ å›é£¯åº—"
        ]
      },
      {
        dayKey: "day3",
        dateLabel: "Day 3ï½œ1/26ï¼ˆä¸€ï¼‰",
        title: "äº¬éƒ½éƒŠå€ï½œåµå±±è‡ªç„¶ç³»",
        items: [
          "08:30 å‡ºé–€",
          "09:30â€“10:00 æŠµé”åµå±±",
          "10:00â€“11:30 ç«¹æ—ï¼‹å‘¨é‚Šæ•£æ­¥",
          "11:45â€“12:45 ğŸ± åˆé¤ï¼š[åµå±±å¤§å–„](https://maps.google.com/?q=%E5%B5%90%E5%B1%B1%E5%A4%A7%E5%96%84)ï¼ˆå£½å¸ï½œå¯ç¾å ´ï½œåˆå¸‚ï¼‰",
          "13:00â€“14:00 æ¸¡æœˆæ©‹ï¼‹æ²³ç•”",
          "14:30â€“15:30 â˜… å’–å•¡ï¼ç”œé»",
          "16:00â€“17:00 å›å¤§é˜ª",
          "18:30â€“20:00 ğŸ½ æ™šé¤ï¼š[å±…é…’å±‹ ã¨ã‚ˆ](https://maps.google.com/?q=%E5%B1%85%E9%85%92%E5%B1%8B%20%E3%81%A8%E3%82%88)ï¼ˆæµ·é®®å±…é…’å±‹ï½œå¯ç¾å ´ï¼Œå¸¸æ’éšŠï¼‰"
        ]
      },
      {
        dayKey: "day4",
        dateLabel: "Day 4ï½œ1/27ï¼ˆäºŒï¼‰",
        title: "äº¬éƒ½éƒŠå€ï½œæ¸…æ°´å¯ºãƒ»å¤è¡—",
        items: [
          "08:30 å‡ºé–€",
          "09:45â€“11:30 æ¸…æ°´å¯º",
          "11:30â€“13:00 äºŒå¹´å‚ãƒ»ä¸‰å¹´å‚ï¼ˆé‚Šèµ°é‚Šåƒï¼‰",
          "12:15â€“13:00 ğŸ± åˆé¤ï¼š[é®¨ ã‚ˆã—ç”°](https://maps.google.com/?q=%E9%AE%A8%20%E3%82%88%E3%81%97%E7%94%B0%20%E4%BA%AC%E9%83%BD)ï¼ˆå£½å¸ï½œå¿…è¨‚ä½ï½œåˆå¸‚é™å®šï¼‰",
          "13:30â€“14:30 å…«å‚ç¥ç¤¾",
          "15:00â€“16:00 â˜… ç¥‡åœ’å’–å•¡",
          "16:30â€“17:30 å›å¤§é˜ª",
          "18:30â€“20:00 ğŸ½ æ™šé¤ï¼š[ã¯ã‚Šé‡ é“é “å €æœ¬åº—](https://maps.google.com/?q=%E3%81%AF%E3%82%8A%E9%87%8D%20%E9%81%93%E9%A0%93%E5%A0%80%E6%9C%AC%E5%BA%97)ï¼ˆå£½å–œç‡’ï½œå¿…è¨‚ä½ï¼‰"
        ]
      },
      {
        dayKey: "day5",
        dateLabel: "Day 5ï½œ1/28ï¼ˆä¸‰ï¼‰",
        title: "å¤§é˜ªå¸‚å€ï½œç’°çƒå½±åŸ USJ",
        items: [
          "06:30 èµ·åºŠ",
          "07:00 å‡ºé–€",
          "07:30â€“08:00 æŠµé”åœ’å€æ’éšŠ",
          "08:30â€“12:30 è¶…ç´šä»»å¤©å ‚ä¸–ç•Œï¼ˆå„ªå…ˆï¼‰",
          "12:30â€“13:30 ğŸ± åˆé¤ï¼šUSJ åœ’å…§ï¼ˆå»ºè­°ææ—©ç”¨é¤é¿é–‹å°–å³°ï¼‰",
          "13:30â€“17:30 å“ˆåˆ©æ³¢ç‰¹ï¼‹éŠæ¨‚è¨­æ–½",
          "18:00â€“19:00 ğŸ½ æ™šé¤ï¼šUSJ Citywalkï¼ˆæˆ–åœ’å…§ï¼‰",
          "19:30â€“20:30 â˜… å¤œé–“è¡¨æ¼”ï¼å†ç©ä¸€æ¬¡",
          "21:30 å›é£¯åº—"
        ]
      },
      {
        dayKey: "day6",
        dateLabel: "Day 6ï½œ1/29ï¼ˆå››ï¼‰",
        title: "ç¥æˆ¶éƒŠå€ï½œæ¸¯ç£ï¼‹å¤œæ™¯",
        items: [
          "09:00 å‡ºé–€",
          "10:00â€“11:30 åŒ—é‡ç•°äººé¤¨",
          "12:00â€“13:30 ğŸ± åˆé¤ï¼š[ç¥æˆ¸ç‰›ã‚¹ãƒ†ãƒ¼ã‚­ Ishida. æœ¬åº—](https://maps.google.com/?q=%E7%A5%9E%E6%88%B8%E7%89%9B%E3%82%B9%E3%83%86%E3%83%BC%E3%82%AD%20Ishida.%20%E6%9C%AC%E5%BA%97)ï¼ˆéµæ¿ç‡’ï½œå¿…è¨‚ä½ï¼å¯ç·šä¸Šé ç´„ï¼‰",
          "14:00â€“15:30 ç¥æˆ¶æ¸¯æ•£æ­¥",
          "16:30â€“18:00 æ‘©è€¶å±±å¤œæ™¯ï¼ˆæˆ–æ¸¯å¡”ï¼‰",
          "19:30â€“ å›å¤§é˜ª",
          "20:15â€“21:30 ğŸ½ æ™šé¤ï¼ˆå›å¤§é˜ªå¾Œï¼‰ï¼š[éººã‚„è€Œä»Š å¤§æ±æœ¬åº—](https://maps.google.com/?q=%E9%BA%BA%E3%82%84%E8%80%8C%E4%BB%8A%20%E5%A4%A7%E6%9D%B1%E6%9C%AC%E5%BA%97)ï¼ˆæ‹‰éºµï½œå¯ç¾å ´ï¼Œæ’éšŠï¼‰"
        ]
      },
      {
        dayKey: "day7",
        dateLabel: "Day 7ï½œ1/30ï¼ˆäº”ï¼‰",
        title: "å¤§é˜ªåŠéƒŠå€ï½œæº«æ³‰ï¼‹æ¸¯ç£æ•£æ­¥ï¼‹æ¢…ç”°",
        items: [
          "09:30 å‡ºé–€",
          "10:30â€“14:00 ç©ºåº­æº«æ³‰ï¼ˆæ³¡æ¹¯ï¼‹ä¼‘æ¯ï¼‰",
          "14:15â€“15:00 ğŸ± åˆé¤ï¼š[å¹¸é‹å¯¿ã—](https://maps.google.com/?q=%E5%B9%B8%E9%81%8B%E5%AF%BF%E3%81%97%20%E5%BC%81%E5%A4%A9%E7%94%BA)ï¼ˆå£½å¸ï½œå¯ç¾å ´ï½œåˆå¸‚ï¼‰",
          "15:15â€“16:30 å¤©ä¿å±±ï¼å¤§é˜ªæ¸¯ï¼ˆæµ·é‚Šæ•£æ­¥ã€æ‘©å¤©è¼ªè¦–æƒ…æ³ï¼‰",
          "17:00â€“18:00 ç§»å‹• â†’ æ¢…ç”°",
          "18:30â€“20:00 ğŸ½ æ™šé¤ï¼š[å¯¿å¸èµ¤é…¢ éŠ ãƒãƒ«ãƒã‚«03](https://maps.google.com/?q=%E5%AF%BF%E5%8F%B8%E8%B5%A4%E9%85%A2%20%E9%81%8A%20%E3%83%90%E3%83%AB%E3%83%81%E3%82%AB03)ï¼ˆå£½å¸ï½œå¿…è¨‚ä½å»ºè­°ï¼‰",
          "20:00â€“ å›é£¯åº—æ•´ç†è¡Œæ"
        ]
      },
      {
        dayKey: "day8",
        dateLabel: "Day 8ï½œ1/31ï¼ˆå…­ï¼‰",
        title: "Outletï¼‹å›ç¨‹",
        items: [
          "09:30 é€€æˆ¿",
          "10:30â€“14:30 è‡¨ç©ºåŸ Outletï¼ˆåˆé¤åœ¨æ­¤ï¼‰",
          "12:00â€“13:00 ğŸ± åˆé¤ï¼šè‡¨ç©ºåŸ Outletï¼ˆç¾å ´é¸æ“‡ï¼‰",
          "17:30â€“18:00 æŠµé”é—œè¥¿æ©Ÿå ´",
          "20:15 èµ·é£› âœˆï¸"
        ]
      }
    ];

    // åˆå§‹æ˜ç´°ï¼ˆå¯ç•™ç©ºï¼‰
    const initialExpenseDetails = [
      // { id: "e1", dayKey: "day1", payer: "Lok", title: "äº¤é€š", amount: 1200 }
    ];

    /***********************
     * 3) ç‹€æ…‹
     ***********************/
    let itinerary = structuredClone(initialItinerary);
    let expenseDetails = structuredClone(initialExpenseDetails);

    let isEditMode = false;
    let isApplyingRemote = false;
    let debounceTimer = null;
    let itineraryDirty = false;          // è¡Œç¨‹/æ’åº/å¤©æ•¸è®Šæ›´ï¼šåªåœ¨ã€Œå®Œæˆä¿®æ”¹ã€æ‰åŒæ­¥
    let pendingRemoteData = null;        // ç·¨è¼¯ä¸­æ”¶åˆ°é ç«¯æ›´æ–°ï¼Œå…ˆæš«å­˜ï¼Œé¿å…æ‰“æ–·è¼¸å…¥

    /***********************
     * 4) UI å…ƒä»¶
     ***********************/
    const itineraryListEl = document.getElementById("itineraryList");
    const resetOrderBtn = document.getElementById("resetOrderBtn");
    const editModeBtn = document.getElementById("editModeBtn");

    const expDaySelect = document.getElementById("expDaySelect");
    const expPayerSelect = document.getElementById("expPayerSelect");
    const expTitle = document.getElementById("expTitle");
    const expAmount = document.getElementById("expAmount");
    const addExpenseBtn = document.getElementById("addExpenseBtn");

    const expenseTbody = document.getElementById("expenseTbody");

    const syncDot = document.getElementById("syncDot");
    const syncText = document.getElementById("syncText");

    function setSyncState(state, text){
      syncDot.classList.remove("ok","err","busy");
      if(state) syncDot.classList.add(state);
      syncText.textContent = text || "â€”";
    }

    // è¡Œç¨‹ç·¨è¼¯ä¸­ï¼šå…ˆåªæ”¹æœ¬åœ°ï¼Œä¸è¦è§¸ç™¼é›²ç«¯åŒæ­¥ï¼ˆé¿å…é ç«¯åŒæ­¥å°è‡´é‡ç¹ªæ‰“æ–·è¼¸å…¥ï¼‰
    function markItineraryDirty(){
      itineraryDirty = true;
      setSyncState("busy", "ç·¨è¼¯ä¸­ï¼ˆæœªåŒæ­¥ï¼‰");
    }

    /***********************
     * 5) è¨ˆç®—æ¯æ—¥å¯¦éš›èŠ±è²»ï¼ˆä¸å¯æ‰‹å‹•æ”¹ï¼‰
     ***********************/
    function getDayTotal(dayKey){
      return expenseDetails
        .filter(x => x.dayKey === dayKey)
        .reduce((sum, x) => sum + (Number(x.amount) || 0), 0);
    }

    function formatJPY(n){
      const v = Number(n) || 0;
      return v.toLocaleString("ja-JP");
    }

    // ç·¨è¼¯æ¨¡å¼ä¸‹é¿å…æ•´å€‹é‡ç¹ªè¡Œç¨‹ï¼ˆæœƒæ‰“æ–·è¼¸å…¥ï¼‰ï¼Œåªæ›´æ–°æ¯ä¸€å¤©çš„ã€Œå¯¦éš›èŠ±è²»ã€é¡¯ç¤º
    function updateCostDisplay(){
      const els = document.querySelectorAll('.cost-val[data-daykey]');
      els.forEach(el => {
        const dk = el.getAttribute('data-daykey');
        el.textContent = formatJPY(getDayTotal(dk));
      });
    }

    /***********************
     * 6) Render è¡Œç¨‹
     ***********************/
    function renderItinerary(){
      itineraryListEl.innerHTML = "";

      itinerary.forEach((day, idx) => {
        const card = document.createElement("div");
        card.className = "day-card";
        card.draggable = !isEditMode;
        card.dataset.index = String(idx);
        card.dataset.dayKey = day.dayKey;

        // Drag events
        card.addEventListener("dragstart", (e) => {
          if(isEditMode) return;
          e.dataTransfer.setData("text/plain", String(idx));
          e.dataTransfer.effectAllowed = "move";
          card.style.opacity = "0.6";
        });
        card.addEventListener("dragend", () => {
          card.style.opacity = "1";
        });
        card.addEventListener("dragover", (e) => {
          if(isEditMode) return;
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });
        card.addEventListener("drop", (e) => {
          if(isEditMode) return;
          e.preventDefault();
          const fromIdx = Number(e.dataTransfer.getData("text/plain"));
          const toIdx = idx;
          if(Number.isNaN(fromIdx) || fromIdx === toIdx) return;
          const moved = itinerary.splice(fromIdx, 1)[0];
          itinerary.splice(toIdx, 0, moved);
          renderItinerary();
          scheduleSave();
        });

        // Header
        const head = document.createElement("div");
        head.className = "day-head";

        const left = document.createElement("div");
        left.className = "day-left";

        const h = document.createElement("p");
        h.className = "day-title";
        h.innerHTML = `
          <span>${day.dateLabel}ï½œ${escapeHtml(day.title)}</span>
          <span class="badge">${day.dayKey.toUpperCase()}</span>
        `;
        left.appendChild(h);

        const hint = document.createElement("div");
        hint.className = "drag-hint";
        hint.textContent = isEditMode ? "ç·¨è¼¯æ¨¡å¼ä¸­ï¼šå¯ä¿®æ”¹å…§å®¹" : "æ‹–æ›³æ­¤å¡å¯é‡æ–°æ’åº";
        left.appendChild(hint);

        const actions = document.createElement("div");
        actions.className = "day-actions";

        if(isEditMode){
          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger";
          delBtn.innerHTML = `<span class="icon i-trash"></span> åˆªé™¤`;
          delBtn.addEventListener("click", () => {
            if(!confirm(`ç¢ºå®šåˆªé™¤ ${day.dateLabel} ï¼Ÿ`)) return;
            // åŒæ™‚åˆªé™¤è©²æ—¥æ˜ç´°
            expenseDetails = expenseDetails.filter(x => x.dayKey !== day.dayKey);
            itinerary = itinerary.filter(x => x.dayKey !== day.dayKey);
            refreshExpenseDaySelect();
            renderItinerary();
            renderExpenses();
            markItineraryDirty();
          });
          actions.appendChild(delBtn);
        }

        head.appendChild(left);
        head.appendChild(actions);

        // Body
        const body = document.createElement("div");
        body.className = "day-body";

        if(!isEditMode){
          const ul = document.createElement("ul");
          ul.className = "items";
          day.items.forEach(line => {
            const li = document.createElement("li");
            li.innerHTML = renderLineHTML(line);
            ul.appendChild(li);
          });
          body.appendChild(ul);
        }else{
          const wrap = document.createElement("div");
          wrap.className = "edit-area";

          const f1 = document.createElement("div");
          f1.className = "field";
          f1.innerHTML = `<label>æ—¥æœŸæ¨™ç±¤ï¼ˆä¾‹ï¼šDay 1ï½œ1/24ï¼ˆå…­ï¼‰ï¼‰</label>`;
          const inDate = document.createElement("input");
          inDate.type = "text";
          inDate.value = day.dateLabel;
          inDate.addEventListener("input", () => {
            day.dateLabel = inDate.value;
            refreshExpenseDaySelect();
            markItineraryDirty();
          });
          f1.appendChild(inDate);

          const f2 = document.createElement("div");
          f2.className = "field";
          f2.innerHTML = `<label>æ¨™é¡Œï¼ˆä¾‹ï¼šæŠµé”å¤§é˜ªãƒ»å¸‚å€æš–èº«ï¼‰</label>`;
          const inTitle = document.createElement("input");
          inTitle.type = "text";
          inTitle.value = day.title;
          inTitle.addEventListener("input", () => {
            day.title = inTitle.value;
            markItineraryDirty();
          });
          f2.appendChild(inTitle);

          const f3 = document.createElement("div");
          f3.className = "field";
          f3.innerHTML = `<label>è¡Œç¨‹å…§å®¹ï¼ˆæ¯è¡Œä¸€é …ï¼‰</label>`;
          const ta = document.createElement("textarea");
          ta.value = day.items.join("\n");
          ta.addEventListener("input", () => {
            day.items = ta.value.split("\n").map(s => s.trim()).filter(Boolean);
            markItineraryDirty();
          });
          f3.appendChild(ta);

          wrap.appendChild(f1);
          wrap.appendChild(f2);
          wrap.appendChild(f3);
          body.appendChild(wrap);
        }

        // Daily cost row (computed)
        const costRow = document.createElement("div");
        costRow.className = "cost-row";
        const total = getDayTotal(day.dayKey);
        costRow.innerHTML = `
          <div>å¯¦éš›èŠ±è²»ï¼ˆJPYï¼‰</div>
          <div class="cost-val" data-daykey="${day.dayKey}">${formatJPY(total)}</div>
        `;
        body.appendChild(costRow);

        card.appendChild(head);
        card.appendChild(body);
        itineraryListEl.appendChild(card);
      });
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderLineHTML(line){
      const s = String(line ?? "");
      const re = /\[([^\]]+?)\]\((https?:\/\/[^\s)]+)\)/g;
      let out = "";
      let last = 0;
      let m;
      while((m = re.exec(s)) !== null){
        const before = s.slice(last, m.index);
        out += escapeHtml(before);
        const text = m[1];
        const url = m[2];
        const safe = url.startsWith("https://maps.google.com/") || url.startsWith("https://www.google.com/maps");
        if(safe){
          out += `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(text)}</a>`;
        }else{
          out += escapeHtml(text);
        }
        last = m.index + m[0].length;
      }
      out += escapeHtml(s.slice(last));
      // â˜… é«˜äº®
      out = out.replaceAll("â˜…", `<span class="star">â˜…</span>`);
      return out;
    }

    /***********************
     * 7) æ˜ç´°è¨˜è³¬ UI
     ***********************/
    function refreshExpenseDaySelect(){
      const old = expDaySelect.value;
      expDaySelect.innerHTML = "";
      itinerary.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.dayKey;
        opt.textContent = `${d.dateLabel}ï½œ${d.title}`;
        expDaySelect.appendChild(opt);
      });
      if(old && [...expDaySelect.options].some(o => o.value === old)){
        expDaySelect.value = old;
      }
    }

    function renderExpenses(){
      expenseTbody.innerHTML = "";

      // æŒ‰ dayKey / æ’å…¥é †åºç°¡å–®æ’åºï¼šå…ˆä¾ itinerary çš„é †åºï¼Œå†ä¾å»ºç«‹é †åº
      const dayOrder = new Map(itinerary.map((d,i)=>[d.dayKey,i]));
      const rows = [...expenseDetails].sort((a,b)=>{
        return (dayOrder.get(a.dayKey) ?? 999) - (dayOrder.get(b.dayKey) ?? 999);
      });

      rows.forEach((x) => {
        const tr = document.createElement("tr");

        const day = itinerary.find(d => d.dayKey === x.dayKey);
        const dayText = day ? day.dateLabel : x.dayKey;

        tr.innerHTML = `
          <td>${escapeHtml(dayText)}</td>
          <td>${escapeHtml(x.payer)}</td>
          <td>${escapeHtml(x.title)}</td>
          <td>${formatJPY(x.amount)}</td>
          <td></td>
        `;

        const tdBtn = tr.querySelector("td:last-child");
        const del = document.createElement("button");
        del.className = "btn-danger";
        del.style.padding = "7px 9px";
        del.innerHTML = `<span class="icon i-trash"></span>`;
        del.title = "åˆªé™¤";
        del.addEventListener("click", () => {
          if(!confirm("åˆªé™¤é€™ç­†æ˜ç´°ï¼Ÿ")) return;
          expenseDetails = expenseDetails.filter(e => e.id !== x.id);
          renderExpenses();
          if(isEditMode){
            updateCostDisplay();
          }else{
            renderItinerary();
          }
          scheduleSave({ allowDuringEdit: true });
        });
        tdBtn.appendChild(del);

        expenseTbody.appendChild(tr);
      });
    }

    function addExpense(){
      const dayKey = expDaySelect.value;
      const payer = expPayerSelect.value;
      const title = expTitle.value.trim();
      const amountRaw = expAmount.value.trim();

      const amount = Number(amountRaw.replaceAll(",",""));
      if(!dayKey) return alert("è«‹é¸æ“‡æ—¥æœŸ");
      if(!title) return alert("è«‹è¼¸å…¥é …ç›®");
      if(!Number.isFinite(amount) || amount <= 0) return alert("é‡‘é¡è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸å­—ï¼ˆJPYï¼‰");

      const id = "e_" + Math.random().toString(36).slice(2) + "_" + Date.now();
      expenseDetails.push({ id, dayKey, payer, title, amount });

      expTitle.value = "";
      expAmount.value = "";

      renderExpenses();
      if(isEditMode){
        updateCostDisplay();
      }else{
        renderItinerary();
      }
      scheduleSave({ allowDuringEdit: true });
    }

    addExpenseBtn.addEventListener("click", addExpense);
    expAmount.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addExpense();
    });

    /***********************
     * 8) ç·¨è¼¯æ¨¡å¼ / é‡ç½®æ’åº
     ***********************/
    editModeBtn.addEventListener("click", async () => {
      // é€²å…¥/é›¢é–‹ç·¨è¼¯æ¨¡å¼
      isEditMode = !isEditMode;
      editModeBtn.classList.toggle("btn-primary", !isEditMode);
      editModeBtn.classList.toggle("btn-ok", isEditMode);
      editModeBtn.innerHTML = isEditMode
        ? `<span class="icon i-save"></span> å®Œæˆä¿®æ”¹`
        : `<span class="icon i-edit"></span> ä¿®æ”¹è¡Œç¨‹`;

      if(isEditMode){
        // é€²å…¥ç·¨è¼¯ï¼šæš«åœå¥—ç”¨é ç«¯æ›´æ–°ï¼Œé¿å…è¼¸å…¥ä¸­è¢«é‡ç¹ªæ‰“æ–·
        setSyncState("busy", "ç·¨è¼¯ä¸­ï¼ˆæš«åœåŒæ­¥ï¼‰");
        renderItinerary();
        return;
      }

      // é›¢é–‹ç·¨è¼¯ï¼š
      // 1) è‹¥ä½¿ç”¨è€…æœ‰æ”¹è¡Œç¨‹ï¼Œæ‰åœ¨æ­¤åˆ»æŠŠè¡Œç¨‹è®Šæ›´å¯«åˆ°é›²ç«¯
      if(itineraryDirty){
        await saveStateToCloud(false);
        itineraryDirty = false;
        pendingRemoteData = null; // ä»¥æœ¬åœ°ç‚ºæº–ï¼Œæ¸…æ‰æš«å­˜é ç«¯
      }else if(pendingRemoteData){
        // 2) ä½¿ç”¨è€…æ²’æœ‰æ”¹è¡Œç¨‹ï¼Œä½†ç·¨è¼¯æœŸé–“æœ‰äººæ”¹äº†ï¼šé›¢é–‹ç·¨è¼¯å¾Œå†å¥—ç”¨
        isApplyingRemote = true;
        try{
          if(Array.isArray(pendingRemoteData.itinerary)) itinerary = pendingRemoteData.itinerary;
          if(Array.isArray(pendingRemoteData.expenseDetails)) expenseDetails = pendingRemoteData.expenseDetails;
        }finally{
          isApplyingRemote = false;
          pendingRemoteData = null;
        }
      }

      refreshExpenseDaySelect();
      renderExpenses();
      renderItinerary();
    });

    resetOrderBtn.addEventListener("click", async () => {
      if(!confirm("ç¢ºå®šå›åˆ°å»ºè­°æ’åºï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰é›²ç«¯è¨˜éŒ„ï¼Œä¸¦é‡å»ºç‚ºåˆå§‹å¤§é˜ªè¡Œç¨‹ã€‚")) return;
      itinerary = structuredClone(initialItinerary);
      expenseDetails = structuredClone(initialExpenseDetails);
      refreshExpenseDaySelect();
      renderExpenses();
      renderItinerary();
      await saveStateToCloud(true);
    });

    /***********************
     * 9) Firestore åŒæ­¥
     ***********************/
    async function loadFromCloud(){
      setSyncState("busy", "é€£ç·šä¸­â€¦");
      try{
        const snap = await getDoc(tripDocRef);
        if(snap.exists()){
          const data = snap.data() || {};
          if(Array.isArray(data.itinerary)) itinerary = data.itinerary;
          if(Array.isArray(data.expenseDetails)) expenseDetails = data.expenseDetails;
          setSyncState("ok", "å·²é€£ç·šï¼ˆå·²è¼‰å…¥ï¼‰");
        }else{
          // é›²ç«¯æ²’æœ‰å°±å»ºç«‹ä¸€ä»½
          await setDoc(tripDocRef, { itinerary, expenseDetails });
          setSyncState("ok", "å·²é€£ç·šï¼ˆå·²å»ºç«‹ï¼‰");
        }
      }catch(e){
        console.warn("è®€å–é›²ç«¯å¤±æ•—ï¼š", e);
        setSyncState("err", "é€£ç·šå¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰");
      }
    }

    function scheduleSave({ allowDuringEdit = false } = {}){
      // é¿å…è‡ªå·±å¥—ç”¨é ç«¯æ›´æ–°æ™‚åˆå¯«å›å»é€ æˆå¾ªç’°
      if(isApplyingRemote) return;

      // ç·¨è¼¯è¡Œç¨‹ä¸­ï¼šä¸è‡ªå‹•åŒæ­¥ï¼ˆé¿å…é ç«¯å¿«ç…§è§¸ç™¼é‡ç¹ªï¼Œæ‰“æ–·è¼¸å…¥ï¼‰
      if(isEditMode && !allowDuringEdit){
        markItineraryDirty();
        return;
      }

      setSyncState("busy", "åŒæ­¥ä¸­â€¦");
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => saveStateToCloud(false), 450);
    }

    async function saveStateToCloud(force){
      try{
        await setDoc(tripDocRef, { itinerary, expenseDetails });
        if(force){
          setSyncState("ok", "å·²é‡ç½®ä¸¦åŒæ­¥");
        }else{
          setSyncState("ok", "å·²åŒæ­¥");
        }
      }catch(e){
        console.warn("å„²å­˜åˆ°é›²ç«¯å¤±æ•—ï¼š", e);
        setSyncState("err", "åŒæ­¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰");
      }
    }

    function subscribeCloud(){
      onSnapshot(tripDocRef, (snap) => {
        if(!snap.exists()) return;
        const data = snap.data() || {};

        // ä½ æ­£åœ¨è¼¸å…¥ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰æ™‚ï¼Œå…ˆä¸è¦å¥—ç”¨é ç«¯æ›´æ–°ï¼Œé¿å…æ•´é é‡ç¹ªæ‰“æ–·è¼¸å…¥
        if(isEditMode){
          pendingRemoteData = data;
          setSyncState("busy", "ç·¨è¼¯ä¸­ï¼ˆé ç«¯æ›´æ–°å·²æš«å­˜ï¼‰");
          return;
        }

        // é ç«¯æ›´æ–° â†’ å¥—ç”¨åˆ°æœ¬åœ°
        isApplyingRemote = true;
        try{
          if(Array.isArray(data.itinerary)) itinerary = data.itinerary;
          if(Array.isArray(data.expenseDetails)) expenseDetails = data.expenseDetails;
          refreshExpenseDaySelect();
          renderExpenses();
          renderItinerary();
          setSyncState("ok", "å·²åŒæ­¥ï¼ˆé ç«¯æ›´æ–°ï¼‰");
        }finally{
          // ç¨å¾®å»¶é²é‡‹æ”¾ï¼Œé¿å…æ¥çºŒçš„ render äº‹ä»¶è§¸ç™¼ save
          setTimeout(() => { isApplyingRemote = false; }, 200);
        }
      }, (err) => {
        console.warn("onSnapshot å¤±æ•—ï¼š", err);
        setSyncState("err", "å³æ™‚åŒæ­¥å¤±æ•—");
      });
    }

    /***********************
     * 10) åˆå§‹åŒ–
     ***********************/
    function init(){
      refreshExpenseDaySelect();
      renderExpenses();
      renderItinerary();
    }

    init();
    await loadFromCloud();
    subscribeCloud();
  </script>

  <!--
    âš ï¸ é‡è¦ï¼šè«‹æŠŠ firebaseConfig è£¡çš„ YOUR_* æ›¿æ›æˆä½ åŸæœ¬å·²èƒ½åŒæ­¥æˆåŠŸçš„é‚£çµ„è¨­å®šã€‚
    å¦‚æœä½ åŸæœ¬ HTML å·²ç¶“æœ‰æ­£ç¢ºçš„ configï¼Œå°±æŠŠé‚£æ®µè²¼å›ä¾†å³å¯ã€‚
  -->
</body>
</html>
