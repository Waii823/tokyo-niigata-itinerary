<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>大阪 × 京都 × 神戶｜8天行程（可同步）</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f1730;
      --muted:#a7b1c2;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.10);
      --accent:#7aa6ff;
      --accent2:#74f0c5;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --ok:#74f0c5;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(122,166,255,.25), transparent 60%),
                  radial-gradient(1000px 500px at 80% 0%, rgba(116,240,197,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .page{
      max-width: 1160px;
      margin: 0 auto;
      padding: 20px 16px 36px;
    }
    header{
      padding: 18px 14px 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .title-block h1{
      margin: 0 0 6px;
      font-size: 22px;
      letter-spacing: .3px;
    }
    .subtitle{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1.3fr .9fr;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .panel-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 700;
      font-size: 14px;
    }
    .panel-title-dot{
      width:10px;height:10px;border-radius:99px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 3px rgba(122,166,255,.15);
      flex:0 0 auto;
    }
    .panel-subtitle{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
      max-width: 720px;
    }
    .toolbar{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 12px;
      transition: .15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.08);}
    button:active{transform: translateY(0px);}
    .btn-primary{
      border-color: rgba(122,166,255,.35);
      background: rgba(122,166,255,.14);
    }
    .btn-danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.10);
      color: #ffdede;
    }
    .btn-ok{
      border-color: rgba(116,240,197,.35);
      background: rgba(116,240,197,.10);
    }

    .itinerary-list{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .day-card{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(17,26,46,.68);
      overflow:hidden;
    }
    .day-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .day-left{
      min-width: 0;
    }
    .day-title{
      font-weight: 800;
      font-size: 14px;
      margin:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      font-size: 11px;
      padding: 3px 8px;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      color: var(--muted);
      background: rgba(255,255,255,.04);
    }
    .drag-hint{
      color: var(--muted);
      font-size: 11px;
      margin-top:6px;
    }
    .day-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .icon{
      width:14px;height:14px;display:inline-block;
      background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.35));
      -webkit-mask: var(--mask) no-repeat center / contain;
              mask: var(--mask) no-repeat center / contain;
      opacity:.9;
    }
    .i-edit{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm2.92 2.83H5v-.92l9.06-9.06.92.92L5.92 20.08ZM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/></svg>');}
    .i-trash{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12ZM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4Z"/></svg>');}
    .i-plus{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2Z"/></svg>');}
    .i-reset{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5H5c0 3.87 3.13 7 7 7s7-3.13 7-7-3.13-7-7-7Z"/></svg>');}
    .i-save{ --mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4Zm0 2.5L19.5 8H17V5.5ZM12 19a3 3 0 1 1 0-6 3 3 0 0 1 0 6ZM6 5h9v4H6V5Z"/></svg>');}

    .day-body{
      padding: 10px 12px 12px;
    }

    .items{
      margin: 0;
      padding-left: 18px;
      color: rgba(234,240,255,.95);
      line-height: 1.6;
      font-size: 13px;
    }
    .items li{
      margin: 4px 0;
    }
    .star{
      color: var(--warn);
      font-weight: 800;
    }

    .cost-row{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
    }
    .cost-val{
      color: var(--text);
      font-weight: 800;
      letter-spacing:.2px;
    }

    /* Edit mode */
    .edit-area{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
    }
    input[type="text"], textarea, select{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 10px;
      font-size: 13px;
      outline:none;
    }
    textarea{min-height: 110px; resize: vertical;}

    .right-wrap{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(17,26,46,.68);
      padding: 12px;
    }
    .card h3{
      margin:0 0 8px;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .small{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }
    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
    }
    .table th, .table td{
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 8px 8px;
      font-size: 12px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color: var(--muted); font-weight:700;}
    .table tr:last-child td{border-bottom:none;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row input[type="text"]{flex:1 1 140px;}
    .row select{flex:0 0 120px;}
    .row button{flex:0 0 auto;}

    .sync-ind{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .dot.ok{background: rgba(116,240,197,.9); box-shadow: 0 0 0 3px rgba(116,240,197,.18);}
    .dot.err{background: rgba(255,107,107,.95); box-shadow: 0 0 0 3px rgba(255,107,107,.18);}
    .dot.busy{background: rgba(255,209,102,.95); box-shadow: 0 0 0 3px rgba(255,209,102,.18);}
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="title-block">
        <h1>大阪 × 京都 × 神戶｜8天冬季行程（多人同步版）</h1>
        <div class="subtitle">
          2026/1/24 13:00 抵達關西國際機場 · 2026/1/31 20:15 自關西返程<br />
          市區 × 郊區：大阪（USJ/溫泉/購物）＋ 京都（嵐山/清水寺）＋ 神戶（港灣夜景）
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- 左側：行程 -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <span class="panel-title-dot"></span> 互動行程表（可拖拽排序 / 可編輯文字）
            </div>
            <div class="panel-subtitle">
              拖曳每一天可以重新排程；按「修改行程」進入編輯模式，才能修改標題 / 內容 / 行程項目。
            </div>
          </div>
          <div class="toolbar">
            <button id="resetOrderBtn">
              <span class="icon i-reset"></span> 回到建議排序（會清除所有記錄）
            </button>
            <button id="editModeBtn" class="btn-primary">
              <span class="icon i-edit"></span> 修改行程
            </button>
          </div>
        </div>
        <div id="itineraryList" class="itinerary-list"></div>
      </section>

      <!-- 右側：明細記賬 -->
      <aside class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              <span class="panel-title-dot"></span> 明細記賬（自動加總到每日「實際花費」）
            </div>
            <div class="panel-subtitle">
              任何人新增/修改明細後，會即時同步給所有人；每日「實際花費」不可手動改，只由明細總數計算。
            </div>
          </div>
          <div class="toolbar">
            <div class="sync-ind" title="Firestore 即時同步狀態">
              <span id="syncDot" class="dot"></span>
              <span id="syncText">未連線</span>
            </div>
          </div>
        </div>

        <div class="right-wrap">
          <div class="card">
            <h3>快速新增一筆</h3>
            <div class="row">
              <select id="expDaySelect"></select>
              <select id="expPayerSelect">
                <option value="Lok">Lok</option>
                <option value="Wai">Wai</option>
              </select>
            </div>
            <div class="row">
              <input id="expTitle" type="text" placeholder="項目（例：晚餐、交通、門票…）" />
              <input id="expAmount" type="text" placeholder="金額（JPY）" inputmode="numeric" />
            </div>
            <div class="row">
              <button id="addExpenseBtn" class="btn-ok">
                <span class="icon i-plus"></span> 新增明細
              </button>
            </div>
            <div class="small">提示：金額只接受數字；會自動加總到對應日期。</div>
          </div>

          <div class="card">
            <h3>明細列表</h3>
            <table class="table" id="expenseTable">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>付款人</th>
                  <th>項目</th>
                  <th>金額 (JPY)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="expenseTbody"></tbody>
            </table>
          </div>

          <div class="card">
            <h3>小提示</h3>
            <div class="small">
              <div class="pill">多人同步：同一份文件</div>
              <div class="pill">旅途中網路不穩：稍後會自動重試</div>
              <div class="pill">行程拖拽：可自訂順序</div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Firebase (Firestore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    /***********************
     * 1) Firebase 設定
     ***********************/
    // ⚠️ 請保持與你原本專案一致（你現有 HTML 內的 config）
    // 如果你之前已經能同步成功，這裡通常不用改。
   const firebaseConfig = {
      apiKey: "AIzaSyA56n9PCvDn2izWf3cxm8BVWcMK-bPD6OQ",
      authDomain: "tokyo-trip-2026-5edba.firebaseapp.com",
      projectId: "tokyo-trip-2026-5edba",
      storageBucket: "tokyo-trip-2026-5edba.firebasestorage.app",
      messagingSenderId: "565813798352",
      appId: "1:565813798352:web:50bfe09838fa0f6553c5d5",
      measurementId: "G-0XL0C88XX6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 你們共用的唯一文件（配合 Firestore rules）
    const tripDocRef = doc(db, "trips", "tokyo-trip-2026");

    /***********************
     * 2) 初始行程（大阪 8 天）
     ***********************/
    const initialItinerary = [
      {
        dayKey: "day1",
        dateLabel: "Day 1｜1/24（六）",
        title: "抵達大阪・市區暖身",
        items: [
          "13:00 抵達關西國際機場",
          "13:00–14:30 入境、領行李",
          "14:45–15:30 南海電鐵 → 難波",
          "15:45–16:15 飯店寄放行李／Check-in",
          "16:30–18:00 心齋橋筋商店街（慢逛、不買重物）",
          "18:00–20:00 道頓堀晚餐＋夜景",
          "20:00– 回飯店休息"
        ]
      },
      {
        dayKey: "day2",
        dateLabel: "Day 2｜1/25（日）",
        title: "大阪市區｜市場＋夜景",
        items: [
          "09:00 出門",
          "09:30–11:00 黑門市場（早餐＋午餐一起吃）",
          "11:30–13:00 中崎町咖啡／小店",
          "13:30–15:30 ★ 回飯店休息或梅田百貨",
          "16:00–17:00 梅田空中庭園",
          "17:30–18:00 HEP FIVE 摩天輪",
          "18:30–20:00 梅田晚餐",
          "20:30– 回飯店"
        ]
      },
      {
        dayKey: "day3",
        dateLabel: "Day 3｜1/26（一）",
        title: "京都郊區｜嵐山自然系",
        items: [
          "08:30 出門",
          "09:30–10:00 抵達嵐山",
          "10:00–11:30 竹林＋周邊散步",
          "11:45–12:45 午餐（湯豆腐／日式定食）",
          "13:00–14:00 渡月橋＋河畔",
          "14:30–15:30 ★ 咖啡／甜點",
          "16:00–17:00 回大阪",
          "18:30– 大阪晚餐"
        ]
      },
      {
        dayKey: "day4",
        dateLabel: "Day 4｜1/27（二）",
        title: "京都郊區｜清水寺・古街",
        items: [
          "08:30 出門",
          "09:45–11:30 清水寺",
          "11:30–13:00 二年坂・三年坂（邊走邊吃）",
          "13:30–14:30 八坂神社",
          "15:00–16:00 ★ 祇園咖啡",
          "16:30–17:30 回大阪",
          "18:30– 晚餐"
        ]
      },
      {
        dayKey: "day5",
        dateLabel: "Day 5｜1/28（三）",
        title: "大阪市區｜環球影城 USJ",
        items: [
          "06:30 起床",
          "07:00 出門",
          "07:30–08:00 抵達園區排隊",
          "08:30–12:30 超級任天堂世界（優先）",
          "12:30–13:30 午餐",
          "13:30–17:30 哈利波特＋遊樂設施",
          "18:00–19:00 晚餐",
          "19:30–20:30 ★ 夜間表演／再玩一次",
          "21:30 回飯店"
        ]
      },
      {
        dayKey: "day6",
        dateLabel: "Day 6｜1/29（四）",
        title: "神戶郊區｜港灣＋夜景",
        items: [
          "09:00 出門",
          "10:00–11:30 北野異人館",
          "12:00–13:30 神戶牛午餐（鐵板燒）",
          "14:00–15:30 神戶港散步",
          "16:30–18:00 摩耶山夜景（或港塔）",
          "19:30– 回大阪"
        ]
      },
      {
        dayKey: "day7",
        dateLabel: "Day 7｜1/30（五）",
        title: "大阪市區｜溫泉＋購物",
        items: [
          "10:00 出門",
          "11:00–15:00 空庭溫泉（含午餐）",
          "16:00–18:30 心齋橋／難波購物",
          "19:00– 最後一晚大阪晚餐"
        ]
      },
      {
        dayKey: "day8",
        dateLabel: "Day 8｜1/31（六）",
        title: "Outlet＋回程",
        items: [
          "09:30 退房",
          "10:30–14:30 臨空城 Outlet（午餐在此）",
          "17:30–18:00 抵達關西機場",
          "20:15 起飛 ✈️"
        ]
      }
    ];

    // 初始明細（可留空）
    const initialExpenseDetails = [
      // { id: "e1", dayKey: "day1", payer: "Lok", title: "交通", amount: 1200 }
    ];

    /***********************
     * 3) 狀態
     ***********************/
    let itinerary = structuredClone(initialItinerary);
    let expenseDetails = structuredClone(initialExpenseDetails);

    let isEditMode = false;
    let isApplyingRemote = false;
    let debounceTimer = null;

    /***********************
     * 4) UI 元件
     ***********************/
    const itineraryListEl = document.getElementById("itineraryList");
    const resetOrderBtn = document.getElementById("resetOrderBtn");
    const editModeBtn = document.getElementById("editModeBtn");

    const expDaySelect = document.getElementById("expDaySelect");
    const expPayerSelect = document.getElementById("expPayerSelect");
    const expTitle = document.getElementById("expTitle");
    const expAmount = document.getElementById("expAmount");
    const addExpenseBtn = document.getElementById("addExpenseBtn");

    const expenseTbody = document.getElementById("expenseTbody");

    const syncDot = document.getElementById("syncDot");
    const syncText = document.getElementById("syncText");

    function setSyncState(state, text){
      syncDot.classList.remove("ok","err","busy");
      if(state) syncDot.classList.add(state);
      syncText.textContent = text || "—";
    }

    /***********************
     * 5) 計算每日實際花費（不可手動改）
     ***********************/
    function getDayTotal(dayKey){
      return expenseDetails
        .filter(x => x.dayKey === dayKey)
        .reduce((sum, x) => sum + (Number(x.amount) || 0), 0);
    }

    function formatJPY(n){
      const v = Number(n) || 0;
      return v.toLocaleString("ja-JP");
    }

    /***********************
     * 6) Render 行程
     ***********************/
    function renderItinerary(){
      itineraryListEl.innerHTML = "";

      itinerary.forEach((day, idx) => {
        const card = document.createElement("div");
        card.className = "day-card";
        card.draggable = !isEditMode;
        card.dataset.index = String(idx);

        // Drag events
        card.addEventListener("dragstart", (e) => {
          if(isEditMode) return;
          e.dataTransfer.setData("text/plain", String(idx));
          e.dataTransfer.effectAllowed = "move";
          card.style.opacity = "0.6";
        });
        card.addEventListener("dragend", () => {
          card.style.opacity = "1";
        });
        card.addEventListener("dragover", (e) => {
          if(isEditMode) return;
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });
        card.addEventListener("drop", (e) => {
          if(isEditMode) return;
          e.preventDefault();
          const fromIdx = Number(e.dataTransfer.getData("text/plain"));
          const toIdx = idx;
          if(Number.isNaN(fromIdx) || fromIdx === toIdx) return;
          const moved = itinerary.splice(fromIdx, 1)[0];
          itinerary.splice(toIdx, 0, moved);
          renderItinerary();
          scheduleSave();
        });

        // Header
        const head = document.createElement("div");
        head.className = "day-head";

        const left = document.createElement("div");
        left.className = "day-left";

        const h = document.createElement("p");
        h.className = "day-title";
        h.innerHTML = `
          <span>${day.dateLabel}｜${escapeHtml(day.title)}</span>
          <span class="badge">${day.dayKey.toUpperCase()}</span>
        `;
        left.appendChild(h);

        const hint = document.createElement("div");
        hint.className = "drag-hint";
        hint.textContent = isEditMode ? "編輯模式中：可修改內容" : "拖曳此卡可重新排序";
        left.appendChild(hint);

        const actions = document.createElement("div");
        actions.className = "day-actions";

        if(isEditMode){
          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger";
          delBtn.innerHTML = `<span class="icon i-trash"></span> 刪除`;
          delBtn.addEventListener("click", () => {
            if(!confirm(`確定刪除 ${day.dateLabel} ？`)) return;
            // 同時刪除該日明細
            expenseDetails = expenseDetails.filter(x => x.dayKey !== day.dayKey);
            itinerary = itinerary.filter(x => x.dayKey !== day.dayKey);
            refreshExpenseDaySelect();
            renderItinerary();
            renderExpenses();
            scheduleSave();
          });
          actions.appendChild(delBtn);
        }

        head.appendChild(left);
        head.appendChild(actions);

        // Body
        const body = document.createElement("div");
        body.className = "day-body";

        if(!isEditMode){
          const ul = document.createElement("ul");
          ul.className = "items";
          day.items.forEach(line => {
            const li = document.createElement("li");
            // ★ 高亮
            if(line.includes("★")){
              li.innerHTML = escapeHtml(line).replaceAll("★", `<span class="star">★</span>`);
            }else{
              li.textContent = line;
            }
            ul.appendChild(li);
          });
          body.appendChild(ul);
        }else{
          const wrap = document.createElement("div");
          wrap.className = "edit-area";

          const f1 = document.createElement("div");
          f1.className = "field";
          f1.innerHTML = `<label>日期標籤（例：Day 1｜1/24（六））</label>`;
          const inDate = document.createElement("input");
          inDate.type = "text";
          inDate.value = day.dateLabel;
          inDate.addEventListener("input", () => {
            day.dateLabel = inDate.value;
            refreshExpenseDaySelect();
            scheduleSave();
          });
          f1.appendChild(inDate);

          const f2 = document.createElement("div");
          f2.className = "field";
          f2.innerHTML = `<label>標題（例：抵達大阪・市區暖身）</label>`;
          const inTitle = document.createElement("input");
          inTitle.type = "text";
          inTitle.value = day.title;
          inTitle.addEventListener("input", () => {
            day.title = inTitle.value;
            scheduleSave();
          });
          f2.appendChild(inTitle);

          const f3 = document.createElement("div");
          f3.className = "field";
          f3.innerHTML = `<label>行程內容（每行一項）</label>`;
          const ta = document.createElement("textarea");
          ta.value = day.items.join("\n");
          ta.addEventListener("input", () => {
            day.items = ta.value.split("\n").map(s => s.trim()).filter(Boolean);
            scheduleSave();
          });
          f3.appendChild(ta);

          wrap.appendChild(f1);
          wrap.appendChild(f2);
          wrap.appendChild(f3);
          body.appendChild(wrap);
        }

        // Daily cost row (computed)
        const costRow = document.createElement("div");
        costRow.className = "cost-row";
        const total = getDayTotal(day.dayKey);
        costRow.innerHTML = `
          <div>實際花費（JPY）</div>
          <div class="cost-val">${formatJPY(total)}</div>
        `;
        body.appendChild(costRow);

        card.appendChild(head);
        card.appendChild(body);
        itineraryListEl.appendChild(card);
      });
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     * 7) 明細記賬 UI
     ***********************/
    function refreshExpenseDaySelect(){
      const old = expDaySelect.value;
      expDaySelect.innerHTML = "";
      itinerary.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.dayKey;
        opt.textContent = `${d.dateLabel}｜${d.title}`;
        expDaySelect.appendChild(opt);
      });
      if(old && [...expDaySelect.options].some(o => o.value === old)){
        expDaySelect.value = old;
      }
    }

    function renderExpenses(){
      expenseTbody.innerHTML = "";

      // 按 dayKey / 插入順序簡單排序：先依 itinerary 的順序，再依建立順序
      const dayOrder = new Map(itinerary.map((d,i)=>[d.dayKey,i]));
      const rows = [...expenseDetails].sort((a,b)=>{
        return (dayOrder.get(a.dayKey) ?? 999) - (dayOrder.get(b.dayKey) ?? 999);
      });

      rows.forEach((x) => {
        const tr = document.createElement("tr");

        const day = itinerary.find(d => d.dayKey === x.dayKey);
        const dayText = day ? day.dateLabel : x.dayKey;

        tr.innerHTML = `
          <td>${escapeHtml(dayText)}</td>
          <td>${escapeHtml(x.payer)}</td>
          <td>${escapeHtml(x.title)}</td>
          <td>${formatJPY(x.amount)}</td>
          <td></td>
        `;

        const tdBtn = tr.querySelector("td:last-child");
        const del = document.createElement("button");
        del.className = "btn-danger";
        del.style.padding = "7px 9px";
        del.innerHTML = `<span class="icon i-trash"></span>`;
        del.title = "刪除";
        del.addEventListener("click", () => {
          if(!confirm("刪除這筆明細？")) return;
          expenseDetails = expenseDetails.filter(e => e.id !== x.id);
          renderExpenses();
          renderItinerary(); // 讓每日合計更新
          scheduleSave();
        });
        tdBtn.appendChild(del);

        expenseTbody.appendChild(tr);
      });
    }

    function addExpense(){
      const dayKey = expDaySelect.value;
      const payer = expPayerSelect.value;
      const title = expTitle.value.trim();
      const amountRaw = expAmount.value.trim();

      const amount = Number(amountRaw.replaceAll(",",""));
      if(!dayKey) return alert("請選擇日期");
      if(!title) return alert("請輸入項目");
      if(!Number.isFinite(amount) || amount <= 0) return alert("金額請輸入大於 0 的數字（JPY）");

      const id = "e_" + Math.random().toString(36).slice(2) + "_" + Date.now();
      expenseDetails.push({ id, dayKey, payer, title, amount });

      expTitle.value = "";
      expAmount.value = "";

      renderExpenses();
      renderItinerary();
      scheduleSave();
    }

    addExpenseBtn.addEventListener("click", addExpense);
    expAmount.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addExpense();
    });

    /***********************
     * 8) 編輯模式 / 重置排序
     ***********************/
    editModeBtn.addEventListener("click", () => {
      isEditMode = !isEditMode;
      editModeBtn.classList.toggle("btn-primary", !isEditMode);
      editModeBtn.classList.toggle("btn-ok", isEditMode);
      editModeBtn.innerHTML = isEditMode
        ? `<span class="icon i-save"></span> 完成修改`
        : `<span class="icon i-edit"></span> 修改行程`;
      renderItinerary();
    });

    resetOrderBtn.addEventListener("click", async () => {
      if(!confirm("確定回到建議排序？這會清除所有雲端記錄，並重建為初始大阪行程。")) return;
      itinerary = structuredClone(initialItinerary);
      expenseDetails = structuredClone(initialExpenseDetails);
      refreshExpenseDaySelect();
      renderExpenses();
      renderItinerary();
      await saveStateToCloud(true);
    });

    /***********************
     * 9) Firestore 同步
     ***********************/
    async function loadFromCloud(){
      setSyncState("busy", "連線中…");
      try{
        const snap = await getDoc(tripDocRef);
        if(snap.exists()){
          const data = snap.data() || {};
          if(Array.isArray(data.itinerary)) itinerary = data.itinerary;
          if(Array.isArray(data.expenseDetails)) expenseDetails = data.expenseDetails;
          setSyncState("ok", "已連線（已載入）");
        }else{
          // 雲端沒有就建立一份
          await setDoc(tripDocRef, { itinerary, expenseDetails });
          setSyncState("ok", "已連線（已建立）");
        }
      }catch(e){
        console.warn("讀取雲端失敗：", e);
        setSyncState("err", "連線失敗（請看 Console）");
      }
    }

    function scheduleSave(){
      // 避免自己套用遠端更新時又寫回去造成循環
      if(isApplyingRemote) return;

      setSyncState("busy", "同步中…");
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => saveStateToCloud(false), 450);
    }

    async function saveStateToCloud(force){
      try{
        await setDoc(tripDocRef, { itinerary, expenseDetails });
        if(force){
          setSyncState("ok", "已重置並同步");
        }else{
          setSyncState("ok", "已同步");
        }
      }catch(e){
        console.warn("儲存到雲端失敗：", e);
        setSyncState("err", "同步失敗（請看 Console）");
      }
    }

    function subscribeCloud(){
      onSnapshot(tripDocRef, (snap) => {
        if(!snap.exists()) return;
        const data = snap.data() || {};
        // 遠端更新 → 套用到本地
        isApplyingRemote = true;
        try{
          if(Array.isArray(data.itinerary)) itinerary = data.itinerary;
          if(Array.isArray(data.expenseDetails)) expenseDetails = data.expenseDetails;
          refreshExpenseDaySelect();
          renderExpenses();
          renderItinerary();
          setSyncState("ok", "已同步（遠端更新）");
        }finally{
          // 稍微延遲釋放，避免接續的 render 事件觸發 save
          setTimeout(() => { isApplyingRemote = false; }, 200);
        }
      }, (err) => {
        console.warn("onSnapshot 失敗：", err);
        setSyncState("err", "即時同步失敗");
      });
    }

    /***********************
     * 10) 初始化
     ***********************/
    function init(){
      refreshExpenseDaySelect();
      renderExpenses();
      renderItinerary();
    }

    init();
    await loadFromCloud();
    subscribeCloud();
  </script>

  <!--
    ⚠️ 重要：請把 firebaseConfig 裡的 YOUR_* 替換成你原本已能同步成功的那組設定。
    如果你原本 HTML 已經有正確的 config，就把那段貼回來即可。
  -->
</body>
</html>
